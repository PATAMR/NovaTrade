<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaTrade Pro v12.3 - Multi-Actifs</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* --- 1. CSS VARIABLES --- */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6;
            --border-color: #334155;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --modal-overlay: rgba(0, 0, 0, 0.8);
            --tab-radius: 8px 8px 0 0;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #cbd5e1;
            --modal-overlay: rgba(0, 0, 0, 0.4);
        }

        /* --- 2. BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- 3. UTILITIES --- */
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-2 { gap: 0.5rem; }
        .hidden { display: none !important; }
        .text-green { color: var(--success-color); }
        .text-red { color: var(--danger-color); }
        .font-bold { font-weight: 700; }
        
        .btn {
            padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer;
            font-weight: 600; background: var(--bg-tertiary); color: var(--text-primary);
            transition: 0.2s;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-icon { width: 36px; height: 36px; display: grid; place-items: center; padding: 0; }

        /* --- 4. LAYOUT --- */
        header {
            height: 60px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);
            padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
        }

        .main-grid {
            display: grid; grid-template-columns: 320px 1fr 300px;
            height: calc(100vh - 60px);
        }

        .panel {
            background: var(--bg-primary); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- 5. TABS & LIST --- */
        .tabs-header {
            display: flex; background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color); padding-top: 5px;
        }
        .tab-btn {
            flex: 1; padding: 12px; background: transparent; border: none;
            color: var(--text-secondary); cursor: pointer; font-weight: 600;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: var(--accent-color); border-bottom-color: var(--accent-color);
            background: var(--bg-primary);
        }

        .filters-bar {
            padding: 10px; border-bottom: 1px solid var(--border-color);
            display: flex; gap: 5px;
        }
        .search-input {
            width: 100%; padding: 8px; border-radius: 4px;
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .asset-list { overflow-y: auto; flex: 1; }
        .asset-item {
            padding: 12px 15px; border-bottom: 1px solid var(--border-color);
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .asset-item:hover { background: var(--bg-secondary); }
        .asset-item.active { background: var(--bg-tertiary); border-left: 3px solid var(--accent-color); }
        
        .asset-meta { font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; }
        .asset-price { font-weight: 600; text-align: right; }

        /* --- 6. CHART AREA --- */
        .chart-panel { position: relative; display: flex; flex-direction: column; }
        .chart-header {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .timeframe-btns { background: var(--bg-secondary); padding: 4px; border-radius: 6px; }
        .chart-wrapper { flex: 1; position: relative; padding: 10px; }

        /* --- 7. RIGHT PANEL --- */
        .trade-panel { padding: 20px; overflow-y: auto; }
        .wallet-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;
            border: 1px solid var(--border-color);
        }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-secondary); }
        .input-group input {
            width: 100%; padding: 10px; background: var(--bg-secondary);
            border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px;
        }

        /* --- 8. LOADERS & MODALS --- */
        .loader {
            border: 3px solid var(--bg-tertiary); border-top: 3px solid var(--accent-color);
            border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #loadingOverlay {
            position: absolute; inset: 0; background: rgba(15, 23, 42, 0.7);
            display: flex; justify-content: center; align-items: center; z-index: 10;
        }

        /* Responsive */
        @media (max-width: 1024px) { .main-grid { grid-template-columns: 280px 1fr; } .trade-panel { display: none; } }
        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } .chart-panel { display: none; } }
    </style>
</head>
<body>

    <header>
        <div class="flex align-center gap-2">
            <i class="fas fa-layer-group text-accent" style="color:var(--accent-color)"></i>
            <span class="font-bold" style="font-size:1.1rem">NOVATRADE PRO v12.3</span>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-icon" onclick="app.toggleTheme()"><i class="fas fa-adjust"></i></button>
            <button class="btn btn-icon" onclick="app.exportPDF()"><i class="fas fa-file-pdf"></i></button>
        </div>
    </header>

    <div class="main-grid">
        
        <div class="panel">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="app.switchTab('crypto')">CRYPTO</button>
                <button class="tab-btn" onclick="app.switchTab('stocks')">ACTIONS</button>
                <button class="tab-btn" onclick="app.switchTab('commodities')">MATIÈRES</button>
            </div>

            <div class="filters-bar flex-col gap-2">
                <input type="text" id="searchInput" class="search-input" placeholder="Rechercher actif..." onkeyup="app.filterList()">
                <div class="flex gap-2">
                    <select id="sortSelect" class="search-input" onchange="app.sortList()" style="font-size:0.8rem">
                        <option value="rank">Rang (Top)</option>
                        <option value="gainers">Gainers (+%)</option>
                        <option value="loosers">Losers (-%)</option>
                        <option value="alpha">A-Z</option>
                    </select>
                </div>
            </div>

            <div id="assetList" class="asset-list">
                </div>
            <div id="listLoader" class="flex justify-between" style="padding:20px; justify-content:center"><div class="loader"></div></div>
        </div>

        <div class="panel chart-panel">
            <div id="loadingOverlay" class="hidden"><div class="loader"></div></div>
            
            <div class="chart-header">
                <div>
                    <h2 id="chartTitle">BTC/USD</h2>
                    <div class="flex align-center gap-2">
                        <span id="chartPrice" class="font-bold" style="font-size:1.5rem">$64,000.00</span>
                        <span id="chartChange" class="text-green">+1.5%</span>
                    </div>
                </div>
                <div class="timeframe-btns">
                    <button class="btn" style="padding:4px 8px; font-size:0.75rem" onclick="app.setTimeframe('1H')">1H</button>
                    <button class="btn" style="padding:4px 8px; font-size:0.75rem" onclick="app.setTimeframe('1D')">1D</button>
                    <button class="btn btn-primary" style="padding:4px 8px; font-size:0.75rem" onclick="app.setTimeframe('1W')">1W</button>
                </div>
            </div>

            <div class="chart-wrapper">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="panel trade-panel">
            <div class="wallet-card">
                <div style="font-size:0.8rem; opacity:0.8">PORTEFEUILLE TOTAL</div>
                <h1 id="totalBalance">$50,000.00</h1>
                <div class="text-green" style="font-size:0.8rem"><i class="fas fa-arrow-up"></i> +$1,240 (24h)</div>
            </div>

            <div style="margin-top:20px">
                <h3 style="margin-bottom:15px">Placer un ordre</h3>
                <div class="input-group">
                    <label>Action</label>
                    <div class="flex gap-2">
                        <button class="btn btn-success" style="flex:1">ACHAT</button>
                        <button class="btn btn-danger" style="flex:1">VENTE</button>
                    </div>
                </div>
                <div class="input-group">
                    <label>Montant (USD)</label>
                    <input type="number" id="tradeAmount" value="1000">
                </div>
                <div class="input-group">
                    <label>Effet de levier</label>
                    <input type="range" min="1" max="10" value="1" style="width:100%">
                    <div style="text-align:right; font-size:0.8rem">x1</div>
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="app.executeTrade()">VALIDER L'ORDRE</button>
            </div>
        </div>
    </div>

    <script type="module">
        /**
         * 1. SERVICES DE DONNÉES (Pattern Factory)
         * Gère la récupération hétérogène (API vs Mock)
         */
        class DataService {
            constructor() {
                this.cache = {};
                this.cacheTTL = 60 * 1000; // 1 minute
            }

            async getAssets(category) {
                const cacheKey = `data_${category}`;
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    const { timestamp, data } = JSON.parse(cached);
                    if (Date.now() - timestamp < this.cacheTTL) {
                        return data;
                    }
                }

                let data = [];
                try {
                    if (category === 'crypto') {
                        data = await this.fetchCryptos();
                    } else if (category === 'stocks') {
                        data = await this.generateStocks();
                    } else if (category === 'commodities') {
                        data = await this.generateCommodities();
                    }
                } catch (e) {
                    console.error("Fetch Error, using fallback", e);
                    // Fallback si l'API échoue
                    data = category === 'crypto' ? this.getMockCrypto() : [];
                }

                // Save to cache
                localStorage.setItem(cacheKey, JSON.stringify({
                    timestamp: Date.now(),
                    data: data
                }));
                return data;
            }

            async fetchCryptos() {
                const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false');
                if (!res.ok) throw new Error('API Rate Limit');
                const raw = await res.json();
                return raw.map(c => ({
                    id: c.id,
                    symbol: c.symbol.toUpperCase(),
                    name: c.name,
                    price: c.current_price,
                    change: c.price_change_percentage_24h,
                    cap: c.market_cap,
                    type: 'crypto'
                }));
            }

            // Moteur de Simulation pour Stocks (car pas d'API free stable CORS)
            async generateStocks() {
                await new Promise(r => setTimeout(r, 600)); // Simuler délai réseau
                const stocks = [
                    {s:'AAPL', n:'Apple Inc.', p:220}, {s:'MSFT', n:'Microsoft', p:415},
                    {s:'NVDA', n:'Nvidia', p:880}, {s:'GOOGL', n:'Alphabet', p:175},
                    {s:'AMZN', n:'Amazon', p:180}, {s:'META', n:'Meta Platforms', p:490},
                    {s:'TSLA', n:'Tesla', p:170}, {s:'LVMH', n:'LVMH', p:850},
                    {s:'JPM', n:'JPMorgan Chase', p:195}, {s:'V', n:'Visa', p:280},
                    {s:'WMT', n:'Walmart', p:60}, {s:'XOM', n:'Exxon Mobil', p:118},
                    {s:'MA', n:'Mastercard', p:455}, {s:'PG', n:'Procter & Gamble', p:168},
                    {s:'OR.PA', n:'L\'Oréal', p:445}, {s:'SAP', n:'SAP SE', p:178},
                    {s:'ASML', n:'ASML Holding', p:980}, {s:'SIE.DE', n:'Siemens', p:175},
                    {s:'AIR.PA', n:'Airbus', p:165}, {s:'MC.PA', n:'LVMH', p:860}
                ];
                
                return stocks.map((s, i) => ({
                    id: s.s,
                    symbol: s.s,
                    name: s.n,
                    price: s.p * (1 + (Math.random() * 0.04 - 0.02)), // Variation aléatoire réaliste
                    change: (Math.random() * 5 - 2.5), // -2.5% à +2.5%
                    cap: 1000000000 * (20 - i), // Fake Market Cap descendant
                    type: 'stock'
                }));
            }

            async generateCommodities() {
                await new Promise(r => setTimeout(r, 600));
                const commodities = [
                    {s:'XAU', n:'Gold / Or', p:2650}, {s:'XAG', n:'Silver / Argent', p:31.50},
                    {s:'WTI', n:'Crude Oil WTI', p:78.50}, {s:'BRENT', n:'Brent Oil', p:82.20},
                    {s:'NG', n:'Natural Gas', p:2.80}, {s:'HG', n:'Copper / Cuivre', p:4.45},
                    {s:'PT', n:'Platinum', p:980}, {s:'PA', n:'Palladium', p:1050},
                    {s:'ZW', n:'Wheat / Blé', p:560}, {s:'ZC', n:'Corn / Maïs', p:440},
                    {s:'KC', n:'Coffee / Café', p:225}, {s:'ZS', n:'Soybeans', p:1180}
                ];

                return commodities.map(c => ({
                    id: c.s,
                    symbol: c.s,
                    name: c.n,
                    price: c.p * (1 + (Math.random() * 0.02 - 0.01)),
                    change: (Math.random() * 4 - 2),
                    cap: 0,
                    type: 'commodity'
                }));
            }

            getMockCrypto() {
                return [
                    {id:'bitcoin', symbol:'BTC', name:'Bitcoin', price:64000, change:1.2},
                    {id:'ethereum', symbol:'ETH', name:'Ethereum', price:3400, change:-0.5}
                ];
            }
        }

        /**
         * 2. UI MANAGER
         */
        class UIManager {
            constructor() {
                this.chart = null;
                this.initChart();
            }

            initChart() {
                const ctx = document.getElementById('mainChart').getContext('2d');
                Chart.defaults.font.family = 'Inter';
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Prix',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: (context) => {
                                const bg = context.chart.ctx.createLinearGradient(0,0,0,300);
                                bg.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                                bg.addColorStop(1, 'rgba(59, 130, 246, 0)');
                                return bg;
                            },
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { position: 'right', grid: { color: '#33415555' } }
                        }
                    }
                });
            }

            renderList(assets, activeId) {
                const container = document.getElementById('assetList');
                container.innerHTML = '';
                document.getElementById('listLoader').classList.add('hidden');

                if (assets.length === 0) {
                    container.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8">Aucun résultat</div>';
                    return;
                }

                assets.forEach(asset => {
                    const el = document.createElement('div');
                    el.className = `asset-item ${asset.id === activeId ? 'active' : ''}`;
                    
                    const priceFmt = asset.price > 10 ? 
                        asset.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 
                        asset.price.toLocaleString(undefined, {minimumFractionDigits: 4});

                    el.innerHTML = `
                        <div>
                            <div class="font-bold">${asset.symbol}</div>
                            <div class="asset-meta">${asset.name}</div>
                        </div>
                        <div>
                            <div class="asset-price">$${priceFmt}</div>
                            <div class="${asset.change >= 0 ? 'text-green' : 'text-red'}" style="text-align:right; font-size:0.75rem">
                                ${asset.change > 0 ? '+' : ''}${asset.change.toFixed(2)}%
                            </div>
                        </div>
                    `;
                    el.onclick = () => app.selectAsset(asset);
                    container.appendChild(el);
                });
            }

            updateHeader(asset) {
                document.getElementById('chartTitle').innerText = `${asset.symbol} / USD`;
                document.getElementById('chartPrice').innerText = `$${asset.price.toLocaleString()}`;
                const changeEl = document.getElementById('chartChange');
                changeEl.innerText = `${asset.change.toFixed(2)}%`;
                changeEl.className = asset.change >= 0 ? 'text-green' : 'text-red';
            }

            updateChartData(price) {
                // Simulation de données historiques basée sur le prix actuel
                const labels = [];
                const data = [];
                let p = price;
                for(let i=0; i<50; i++) {
                    labels.push(i);
                    // Générer une courbe réaliste inversée
                    data.unshift(p);
                    p = p * (1 + (Math.random()*0.02 - 0.01));
                }
                
                this.chart.data.labels = labels;
                this.chart.data.datasets[0].data = data;
                this.chart.update();
            }
        }

        /**
         * 3. MAIN CONTROLLER
         */
        class App {
            constructor() {
                this.service = new DataService();
                this.ui = new UIManager();
                
                this.state = {
                    tab: 'crypto', // crypto, stocks, commodities
                    assets: [],
                    filteredAssets: [],
                    activeAsset: null,
                    balance: 50000
                };

                // Init
                this.switchTab('crypto');
            }

            async switchTab(tab) {
                // UI Tabs
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active'); // Warning: depends on click event
                
                // Show Loader
                document.getElementById('assetList').innerHTML = '';
                document.getElementById('listLoader').classList.remove('hidden');

                this.state.tab = tab;
                
                // Fetch Data
                this.state.assets = await this.service.getAssets(tab);
                this.state.filteredAssets = [...this.state.assets];
                
                // Select first
                if (this.state.assets.length > 0) {
                    this.selectAsset(this.state.assets[0]);
                }
                
                this.filterList(); // Re-apply current search/sort
            }

            selectAsset(asset) {
                this.state.activeAsset = asset;
                this.ui.updateHeader(asset);
                this.ui.updateChartData(asset.price);
                
                // Refresh list highlight without re-rendering everything (Optimization)
                const items = document.querySelectorAll('.asset-item');
                // Simple re-render for simplicity in this version
                this.ui.renderList(this.state.filteredAssets, asset.id);
            }

            filterList() {
                const query = document.getElementById('searchInput').value.toLowerCase();
                const sort = document.getElementById('sortSelect').value;

                // 1. Filter
                let res = this.state.assets.filter(a => 
                    a.symbol.toLowerCase().includes(query) || 
                    a.name.toLowerCase().includes(query)
                );

                // 2. Sort
                if (sort === 'rank') {
                    // Default order (Market Cap for crypto)
                } else if (sort === 'gainers') {
                    res.sort((a, b) => b.change - a.change);
                } else if (sort === 'loosers') {
                    res.sort((a, b) => a.change - b.change);
                } else if (sort === 'alpha') {
                    res.sort((a, b) => a.symbol.localeCompare(b.symbol));
                }

                this.state.filteredAssets = res;
                this.ui.renderList(res, this.state.activeAsset?.id);
            }

            sortList() {
                this.filterList();
            }
            
            toggleTheme() {
                const html = document.documentElement;
                const current = html.getAttribute('data-theme');
                html.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
            }

            executeTrade() {
                const btn = event.target;
                const oldText = btn.innerText;
                btn.innerText = "ORDRE PLACÉ !";
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerText = oldText;
                    btn.classList.remove('btn-success');
                }, 1500);
            }

            exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(`Rapport NovaTrade - ${this.state.tab.toUpperCase()}`, 10, 10);
                doc.text(`Actif: ${this.state.activeAsset.symbol}`, 10, 20);
                doc.text(`Prix: $${this.state.activeAsset.price}`, 10, 30);
                doc.save("novatrade.pdf");
            }
            
            // Fix for initial load without click event
            setTimeframe(tf) {
                // Just visual for demo
                document.getElementById('loadingOverlay').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    // Randomize chart slightly
                    this.ui.updateChartData(this.state.activeAsset.price);
                }, 500);
            }
        }

        // Init
        window.app = new App();
        // Force initial active tab visual
        document.querySelector('.tab-btn').classList.add('active');
    </script>
</body>
</html>
