<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaTrade Pro v12.0 - Suite Complète</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS VARIABLES & THEMING --- */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #334155;
            --card-radius: 12px;
            --transition-speed: 0.3s;
        }

        [data-theme="light"] {
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #cbd5e1;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        header {
            height: 60px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: calc(100vh - 60px);
            gap: 1px;
            background-color: var(--border-color); /* Creates grid lines */
        }

        .panel {
            background-color: var(--bg-primary);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* --- COMPONENTS --- */
        .logo { font-size: 1.2rem; font-weight: 800; color: var(--accent-color); letter-spacing: 1px; }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .btn:hover { filter: brightness(1.1); }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-icon { padding: 8px; border-radius: 50%; width: 36px; height: 36px; }

        /* Watchlist */
        .market-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .market-item:hover { background-color: var(--bg-secondary); }
        .market-item.active { background-color: var(--bg-tertiary); border-left: 3px solid var(--accent-color); }
        .price-up { color: var(--success-color); }
        .price-down { color: var(--danger-color); }

        /* Chart Area */
        .chart-container {
            flex: 1;
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        #tradingChart { width: 100%; height: 100%; }

        /* Order Panel */
        .order-form { padding: 20px; background: var(--bg-secondary); margin: 10px; border-radius: var(--card-radius); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; color: var(--text-secondary); margin-bottom: 5px; font-size: 0.85rem; }
        .input-group input {
            width: 100%;
            padding: 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
        }
        .trade-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-buy { background-color: var(--success-color); color: white; }
        .btn-sell { background-color: var(--danger-color); color: white; }

        /* Indicators & Skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 20px;
            width: 100%;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-color);
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 1000;
        }
        .toast.show { transform: translateX(0); }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr 300px; }
            .watchlist-panel { display: none; } /* Mobile simplified view */
        }
        @media (max-width: 768px) {
            .main-container { grid-template-columns: 1fr; }
            .controls-panel { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-chart-line"></i> NOVATRADE PRO v12</div>
        <div class="status-bar">
            <span id="connectionStatus" style="font-size: 0.8rem; color: var(--success-color); margin-right: 15px;">● Connecté</span>
            <button class="btn btn-icon" id="themeToggle" title="Mode Sombre/Clair"><i class="fas fa-moon"></i></button>
            <button class="btn btn-icon" id="exportBtn" title="Exporter CSV"><i class="fas fa-file-export"></i></button>
            <button class="btn btn-icon" id="settingsBtn" title="Configuration"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div class="main-container">
        <div class="panel watchlist-panel">
            <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                <input type="text" placeholder="Rechercher..." style="width: 100%; padding: 8px; background: var(--bg-secondary); border: none; color: white; border-radius: 4px;">
            </div>
            <div id="watchlistContainer">
                <div class="market-item"><div class="skeleton"></div></div>
                <div class="market-item"><div class="skeleton"></div></div>
                <div class="market-item"><div class="skeleton"></div></div>
            </div>
        </div>

        <div class="panel">
            <div class="chart-container">
                <canvas id="tradingChart"></canvas>
                <div id="indicatorsOverlay" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 4px; font-size: 0.8rem;">
                    <div>RSI (14): <span id="rsiValue">--</span></div>
                    <div>SMA (20): <span id="smaValue">--</span></div>
                </div>
            </div>
        </div>

        <div class="panel controls-panel">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                <h3 id="selectedAsset">BTC/USD</h3>
                <h1 id="currentPrice" class="price-up" style="margin: 10px 0;">$0.00</h1>
                <small id="priceChange">24h: 0.00%</small>
            </div>

            <div class="order-form">
                <h4>Placer un ordre</h4>
                <div class="input-group">
                    <label>Montant (USD)</label>
                    <input type="number" id="orderAmount" value="1000">
                </div>
                <div class="trade-buttons">
                    <button class="btn btn-buy" onclick="app.placeOrder('buy')">ACHETER</button>
                    <button class="btn btn-sell" onclick="app.placeOrder('sell')">VENDRE</button>
                </div>
            </div>

            <div style="flex: 1; padding: 20px; overflow-y: auto;">
                <h4>Historique (Simulé)</h4>
                <ul id="tradeHistory" style="list-style: none; margin-top: 10px; font-size: 0.9rem;">
                    </ul>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Message de notification</div>

    <script type="module">
        /**
         * 1. ARCHITECTURE: EVENT BUS (Observer Pattern)
         * Permet la communication découplée entre les composants.
         */
        class EventBus {
            constructor() {
                this.events = {};
            }
            on(event, callback) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(callback);
            }
            emit(event, data) {
                if (this.events[event]) this.events[event].forEach(cb => cb(data));
            }
        }
        const bus = new EventBus();

        /**
         * 2. STATE MANAGEMENT CENTRALISÉ
         */
        class Store {
            constructor() {
                this.state = {
                    theme: 'dark',
                    activeAsset: 'bitcoin',
                    marketData: {},
                    history: [],
                    prices: [] // Pour calculs indicateurs
                };
            }
            
            setTheme(theme) {
                this.state.theme = theme;
                document.body.setAttribute('data-theme', theme);
                bus.emit('theme:changed', theme);
            }

            setActiveAsset(assetId) {
                this.state.activeAsset = assetId;
                bus.emit('asset:changed', assetId);
            }

            addTrade(trade) {
                this.state.history.unshift(trade);
                bus.emit('trade:added', trade);
            }
        }
        const store = new Store();

        /**
         * 3. WEB WORKER (In-line Blob)
         * Pour les calculs lourds (Indicateurs Techniques)
         */
        const workerCode = `
            self.onmessage = function(e) {
                const { prices } = e.data;
                if (!prices || prices.length < 15) return;

                // Calcul simple RSI
                let gains = 0, losses = 0;
                for(let i=1; i<15; i++) {
                    const diff = prices[i] - prices[i-1];
                    if(diff >= 0) gains += diff; else losses -= diff;
                }
                const rs = gains / (losses === 0 ? 1 : losses);
                const rsi = 100 - (100 / (1 + rs));

                // Calcul SMA
                const sum = prices.slice(-20).reduce((a, b) => a + b, 0);
                const sma = sum / prices.slice(-20).length;

                self.postMessage({ type: 'indicators', data: { rsi: rsi.toFixed(2), sma: sma.toFixed(2) } });
            };
        `;
        const blob = new Blob([workerCode], { type: "application/javascript" });
        const worker = new Worker(URL.createObjectURL(blob));

        worker.onmessage = (e) => {
            if (e.data.type === 'indicators') {
                bus.emit('indicators:updated', e.data.data);
            }
        };

        /**
         * 4. API SERVICE (Robustesse & Cache)
         */
        class CryptoService {
            constructor() {
                this.baseUrl = 'https://api.coingecko.com/api/v3';
                this.cache = new Map();
                this.retryCount = 0;
            }

            async fetchMarketData() {
                // Fallback gracieux si API échoue ou Rate Limit
                try {
                    const response = await fetch(`${this.baseUrl}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false`);
                    if (!response.ok) throw new Error('API Limit');
                    const data = await response.json();
                    this.retryCount = 0;
                    return data;
                } catch (error) {
                    console.warn("API indisponible, utilisation données simulées/cache");
                    this.retryCount++;
                    // Simulation de données pour la démo si l'API échoue
                    return this.getMockData();
                }
            }

            getMockData() {
                return [
                    { id: 'bitcoin', symbol: 'btc', name: 'Bitcoin', current_price: 64000 + Math.random()*100, price_change_percentage_24h: 1.2 },
                    { id: 'ethereum', symbol: 'eth', name: 'Ethereum', current_price: 3400 + Math.random()*50, price_change_percentage_24h: -0.5 },
                    { id: 'solana', symbol: 'sol', name: 'Solana', current_price: 145 + Math.random()*5, price_change_percentage_24h: 5.4 }
                ];
            }
        }
        const api = new CryptoService();

        /**
         * 5. UI COMPONENTS
         */
        class UIManager {
            constructor() {
                this.chart = null;
                this.initChart();
                this.bindEvents();
                
                // Raccourcis clavier
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'b') store.setActiveAsset('bitcoin');
                    if (e.ctrlKey && e.key === 'e') store.setActiveAsset('ethereum');
                });
            }

            initChart() {
                const ctx = document.getElementById('tradingChart').getContext('2d');
                Chart.defaults.color = '#94a3b8';
                Chart.defaults.borderColor = '#334155';
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Prix USD',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false } }
                    }
                });
            }

            bindEvents() {
                // Observer les changements
                bus.on('asset:changed', (asset) => {
                    this.showToast(`Actif changé : ${asset.toUpperCase()}`);
                    document.getElementById('selectedAsset').innerText = asset.toUpperCase() + "/USD";
                    // Reset chart data simulation
                    this.chart.data.labels = [];
                    this.chart.data.datasets[0].data = [];
                });

                bus.on('theme:changed', (theme) => {
                    const icon = document.querySelector('#themeToggle i');
                    icon.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
                });

                bus.on('indicators:updated', (data) => {
                    document.getElementById('rsiValue').innerText = data.rsi;
                    document.getElementById('rsiValue').style.color = data.rsi > 70 ? '#ef4444' : (data.rsi < 30 ? '#10b981' : '#fff');
                    document.getElementById('smaValue').innerText = data.sma;
                });

                bus.on('trade:added', (trade) => {
                    const list = document.getElementById('tradeHistory');
                    const li = document.createElement('li');
                    li.style.borderBottom = '1px solid var(--border-color)';
                    li.style.padding = '8px 0';
                    li.innerHTML = `
                        <span style="color: ${trade.type === 'buy' ? 'var(--success-color)' : 'var(--danger-color)'}">${trade.type.toUpperCase()}</span> 
                        ${trade.asset} @ ${trade.price.toFixed(2)}
                        <div style="font-size:0.8em; color:var(--text-secondary)">${new Date().toLocaleTimeString()}</div>
                    `;
                    list.prepend(li);
                });
            }

            updateWatchlist(coins) {
                const container = document.getElementById('watchlistContainer');
                container.innerHTML = '';
                
                coins.forEach(coin => {
                    const el = document.createElement('div');
                    el.className = `market-item ${coin.id === store.state.activeAsset ? 'active' : ''}`;
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:bold">${coin.symbol.toUpperCase()}</div>
                            <div style="font-size:0.8rem; color:var(--text-secondary)">${coin.name}</div>
                        </div>
                        <div style="text-align:right">
                            <div>$${coin.current_price.toLocaleString()}</div>
                            <div class="${coin.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down'}" style="font-size:0.8rem">
                                ${coin.price_change_percentage_24h.toFixed(2)}%
                            </div>
                        </div>
                    `;
                    el.onclick = () => store.setActiveAsset(coin.id);
                    container.appendChild(el);
                });
            }

            updatePriceDisplay(price, change) {
                const el = document.getElementById('currentPrice');
                el.innerText = `$${price.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
                el.className = change >= 0 ? 'price-up' : 'price-down';
                document.getElementById('priceChange').innerText = `24h: ${change}%`;
            }

            updateChart(price) {
                const now = new Date().toLocaleTimeString();
                if (this.chart.data.labels.length > 50) {
                    this.chart.data.labels.shift();
                    this.chart.data.datasets[0].data.shift();
                }
                this.chart.data.labels.push(now);
                this.chart.data.datasets[0].data.push(price);
                this.chart.update('none'); // 'none' for performance
            }

            showToast(msg) {
                const toast = document.getElementById('toast');
                toast.innerText = msg;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }
        const ui = new UIManager();

        /**
         * 6. APP LOGIC (Controller)
         */
        class App {
            constructor() {
                this.init();
            }

            async init() {
                // Initial load
                await this.refreshData();
                
                // Real-time loop (simulated polling for demo)
                setInterval(() => this.refreshData(), 3000);

                // Setup Theme Toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    const newTheme = store.state.theme === 'dark' ? 'light' : 'dark';
                    store.setTheme(newTheme);
                });

                // Setup Export
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });
            }

            async refreshData() {
                const data = await api.fetchMarketData();
                ui.updateWatchlist(data);

                // Find active asset data
                const activeData = data.find(c => c.id === store.state.activeAsset) || data[0];
                
                // Simulate price fluctuation for the live chart
                const noise = (Math.random() - 0.5) * (activeData.current_price * 0.001);
                const livePrice = activeData.current_price + noise;

                ui.updatePriceDisplay(livePrice, activeData.price_change_percentage_24h);
                ui.updateChart(livePrice);

                // Send data to worker for indicators
                const prices = store.state.prices;
                prices.push(livePrice);
                if (prices.length > 50) prices.shift();
                worker.postMessage({ prices: prices });
            }

            placeOrder(type) {
                const amount = document.getElementById('orderAmount').value;
                if (!amount || amount <= 0) return ui.showToast("Montant invalide");
                
                // Simulate order execution
                const currentPrice = parseFloat(document.getElementById('currentPrice').innerText.replace('$','').replace(',',''));
                
                store.addTrade({
                    type: type,
                    asset: store.state.activeAsset.toUpperCase(),
                    price: currentPrice,
                    amount: amount
                });
                
                ui.showToast(`Ordre ${type.toUpperCase()} exécuté !`);
            }

            exportData() {
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Type,Asset,Price,Time\n"
                    + store.state.history.map(e => `${e.type},${e.asset},${e.price},${new Date().toISOString()}`).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "novatrade_history.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Start App
        window.app = new App();
    </script>
</body>
</html>
